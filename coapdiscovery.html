<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Finding your CoAP devices - Lectures</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="ietf.html"><strong aria-hidden="true">2.</strong> The IETF</a></li><li class="chapter-item expanded "><a href="coap.html"><strong aria-hidden="true">3.</strong> CoAP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="coapmessage.html"><strong aria-hidden="true">3.1.</strong> A CoAP Message</a></li><li class="chapter-item expanded "><a href="coaplinks.html"><strong aria-hidden="true">3.2.</strong> CoAP Web Linking and Serialization</a></li><li class="chapter-item expanded "><a href="coapdiscovery.html" class="active"><strong aria-hidden="true">3.3.</strong> Finding your CoAP devices</a></li></ol></li><li class="chapter-item expanded "><a href="udpddos.html"><strong aria-hidden="true">4.</strong> On DDOS Attacks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="coapddos.html"><strong aria-hidden="true">4.1.</strong> DDOS using CoAP</a></li><li class="chapter-item expanded "><a href="coapexplorer.html"><strong aria-hidden="true">4.2.</strong> CoAP Explorer</a></li></ol></li><li class="chapter-item expanded "><a href="reading.html"><strong aria-hidden="true">5.</strong> Relevant Articles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="10years.html"><strong aria-hidden="true">5.1.</strong> A decade of Internet Evolution</a></li><li class="chapter-item expanded "><a href="another10years.html"><strong aria-hidden="true">5.2.</strong> Another 10 years</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Lectures</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="finding-your-coap-devices"><a class="header" href="#finding-your-coap-devices">Finding your CoAP devices</a></h1>
<p>While we have explained how data is transmitted and how it looks like and we do have URLs to share the location of our CoAP devices, we have to figure out <strong>how to find CoAP devices to begin with</strong> and, once we know the URL of a CoAP device, <strong>how do we know what is on that device</strong>.</p>
<h2 id="discovery-steps"><a class="header" href="#discovery-steps">Discovery steps</a></h2>
<p>There are quite a few steps needed in order to retrieve that particular temperature measurement we are looking for. At a high level they are:</p>
<ol>
<li>Find a Resource Directory (RD).</li>
</ol>
<pre><code class="language-txt">      GET coap://[FF0X::FE]/.well-known/core?rt=core.rd*
</code></pre>
<ol start="2">
<li>Find the Lookup Interface of the RD.</li>
</ol>
<pre><code class="language-txt">      GET coap://rd.jaime.win/.well-known/core?rt=core.rd-lookup-res
</code></pre>
<ol start="3">
<li>Find an endpoint or a temperature resource (for example) Registered in the RD.</li>
</ol>
<pre><code class="language-txt">      GET coap://rd.jaime.win/rd-lookup/res?rt=temperature
</code></pre>
<ol start="4">
<li>Query that Endpoint for the <code>/.well-known/core</code> resource in order to see what's there.</li>
</ol>
<pre><code class="language-txt">      GET coap://[2001:db8:3::123]:5683/.well-known/core?rt=temperature
</code></pre>
<ol start="5">
<li>Query the specific resource you are looking for in order to get the current representation.</li>
</ol>
<pre><code class="language-txt">      GET coap://[2001:db8:3::123]:5683/sensors/temp1
</code></pre>
<p>After this last query you would get back the current value of the temperature. Of course, this series of requests are done only the first time a client connects, when we know nothing about the network or the devices that are in it.</p>
<h2 id="discovering-resources"><a class="header" href="#discovering-resources">Discovering Resources</a></h2>
<p>Let's start with the second question first, how do you find the resources that a device has <em>before</em> asking it for them? Indeed, if we do not have any idea of what the device is supposed to do, it would be impossible to query for anything as we would not know the <code>path</code> part of the URL. To fix that problem, CoAP endpoint can come with a default URI that everyone knows, the <a href="https://tools.ietf.org/html/rfc8428">&quot;well-known&quot;</a> URI.</p>
<p>When using <a href="https://tools.ietf.org/html/rfc6690">CoRE Link Format</a>, this URI is called <code>/.well-known/core</code>. That way, a CoAP client can send a <code>GET</code> request to a CoAP server for <code>/.well-known/core</code> and get in return a list of hypermedia links to other resources hosted in that server. Moreover, it can also filter the output to limit the amount of responses with a query string. For example we could query a CoAP server for all resources of the type <code>temperature</code>.</p>
<pre><code class="language-txt">REQ: GET coap://coap.me:5683/.well-known/core?rt=temperature
RES: 2.05 Content
     &lt;/sensors/temp1&gt;;rt=&quot;temperature&quot;,
     &lt;/sensors/temp2&gt;;rt=&quot;temperature&quot;,
</code></pre>
<p>Once the client knows that there are two sensors of the type <code>temperature</code>, it can decide to follow one of the presented links and query it, for example the first one <code>/sensors/temp1</code>. That way it can find the current value of the resource as we learnt in the previous section.</p>
<pre><code class="language-txt">REQ: GET coap://coap.me:5683/sensors/temp1
RES: 2.05 Content
     [{&quot;n&quot;:&quot;urn:dev:ow:10e2073a01080063&quot;,&quot;u&quot;:&quot;Cel&quot;,&quot;v&quot;:23.1}]
</code></pre>
<h2 id="discovering-coap-endpoints"><a class="header" href="#discovering-coap-endpoints">Discovering CoAP Endpoints</a></h2>
<p>We have explained how to discover the resources on a CoAP endpoint but we have not mentioned how endpoints can be found to begin with.</p>
<p>Networks are and will continue to be heterogeneous, some scenarios foresee the use of multicast, while others have a master/slave approach. Some scenarios will have NATs and firewalls while other - more ideal - will simply have globally addressable IPv6 addresses. Some devices will be asleep while others will be permanently connected.</p>
<p>In scenarios where direct discovery of resources is not possible due to sleeping nodes, disperse networks or inefficiency of multicast it is possible to store information about resources held on other servers on something called a <a href="https://tools.ietf.org/html/draft-ietf-core-resource-directory-20">Resource Directory (RD)</a>.</p>
<pre><code class="language-txt">                Registration         Lookup
                 Interface         Interface
     +----+          |                 |
     | EP |----      |                 |
     +----+    ----  |                 |
                   --|-    +------+    |
     +----+          | ----|      |    |     +--------+
     | EP | ---------|-----|  RD  |----|-----| Client |
     +----+          | ----|      |    |     +--------+
                   --|-    +------+    |
     +----+    ----  |                 |
     | CT |----      |                 |
     +----+
</code></pre>
<p>RD has two interfaces, one for <strong>registration</strong> and another for <strong>lookup</strong>. To start using either fo them we first we need to find the RD. There are several options:</p>
<ul>
<li>Already knowing the IP address. Which means that devices need to be configured with that IP, this is the most common setup.</li>
<li>Using a DNS name for the RD and use DNS to return the IP address of the RD. Which means that devices need to be configured with the domain name (e.g., <code>rd.jaime.win</code>).</li>
<li>Multicast request all RDs in the same multicast group. More on that below.</li>
<li>It could be configured using DNS Service Discovery (<a href="https://tools.ietf.org/html/rfc67630">DNS-SD</a>)</li>
<li>It could be provided by default from the network using <a href="https://tools.ietf.org/html/rfc4861">IPv6 Neighbor Discovery</a> by carrying information about the address of the RD, there is a Resource Directory Address Option (<a href="https://tools.ietf.org/html/draft-ietf-core-resource-directory-20#section-4.1.1">RDAO</a>) for it.</li>
</ul>
<p>After performing the discovery you should get the URI of the resource directory like <code>coap://rd.jaime.win</code></p>
<h3 id="registration"><a class="header" href="#registration">Registration</a></h3>
<p>After discovering the RD a CoAP device can register its resources in it. A minimal registration will contain some endpoint identifier <code>ep</code>, the content format identifier which is <code>40</code> in this case (i.e., <a href="https://www.iana.org/assignments/core-parameters/core-parameters.xhtml"><code>application/link-format</code></a>) as well as a series of links resources that the endpoint wants to register.</p>
<pre><code class="language-md">REQ: POST coap://rd.jaime.win/rd?ep=node1
     ct:40
     &lt;/sensors/temp&gt;;ct=41;rt=&quot;temperature-c&quot;;if=&quot;sensor&quot;;
     &lt;/sensors/light&gt;;ct=41;rt=&quot;light-lux&quot;;if=&quot;sensor&quot;
</code></pre>
<p>The RD will return <code>2.01</code> (Created) response with the location path of the entry in the directory, in this case <code>/rd/4521</code>. That location is used in all subsequent operations on that registration.</p>
<pre><code class="language-md">RES: 2.01 Created
     Location-Path: /rd/4521
</code></pre>
<p>There are several alternatives, like delegating registration to a commissioning tool, requesting the RD to fetch the links from the endpoint and others that are detailed in the RD specification.</p>
<h3 id="lookup"><a class="header" href="#lookup">Lookup</a></h3>
<p>To discover the resources registered with the RD an endpoint can use the lookup interface, which allows lookups for endpoints and resources using known CoRE Link attributes and two additional resource types (<code>rt</code>): <code>core.rd-lookup-res</code> for resources and <code>core.rd-lookup-ep</code> for endpoints.</p>
<p>You will have to ask the RD for its configuration to get which is the path where we can perform lookup, we could ask for all available interfaces by querying <code>/.well-known/core</code> with the query <code>rt=core.rd*</code>.</p>
<pre><code class="language-txt">REQ: GET coap://rd.jaime.win/.well-known/core?rt=core.rd*

RES: 2.05 Content
     &lt;/rd&gt;;rt=&quot;core.rd&quot;;ct=40,
     &lt;/rd-lookup/ep&gt;;rt=&quot;core.rd-lookup-ep&quot;;ct=40,
     &lt;/rd-lookup/res&gt;;rt=&quot;core.rd-lookup-res&quot;;ct=40,
</code></pre>
<p>However, in in this case we just want to find CoAP resources, therefore we query <code>rt=core.rd-lookup-res</code>. The RD returns the lookup interface for resources <code>/rd-lookup/res</code>.</p>
<pre><code class="language-txt">REQ: GET coap://rd.jaime.win/.well-known/core?rt=core.rd-lookup-res
RES: &lt;/rd-lookup/res&gt;;rt=&quot;core.rd-lookup-res&quot;;ct=40
</code></pre>
<p>Once we have the entry point to query the RD we could ask for all links to temperature resources in it with the query parameter <code>rt=temperature</code>.</p>
<pre><code class="language-md">REQ: GET coap://rd.jaime.win/rd-lookup/res?rt=temperature
</code></pre>
<p>The RD will return a list of links that host that type of resource.</p>
<pre><code class="language-md">RES: 2.05 Content
     &lt;coap://[2001:db8:3::123]:61616/temp&gt;;rt=&quot;temperature&quot;;
       anchor=&quot;coap://[2001:db8:3::123]:61616&quot;
     &lt;coap://[2001:db8:3::124]/temphome1&gt;;rt=&quot;temperature&quot;;
       anchor=&quot;coap://[2001:db8:3::124]&quot;,
     &lt;coap://[2001:db8:3::124]/temphome2&gt;;rt=&quot;temperature&quot;;
       anchor=&quot;coap://[2001:db8:3::124]&quot;,
     &lt;coap://[2001:db8:3::124]/temphome3&gt;;rt=&quot;temperature&quot;;
       anchor=&quot;coap://[2001:db8:3::124]&quot;
</code></pre>
<p>You can perform Observe on the Resource Directory in order to see when new links are registered, a very useful feature.</p>
<h3 id="use-of-multicast-in-coap"><a class="header" href="#use-of-multicast-in-coap">Use of Multicast in CoAP</a></h3>
<p>There is an added benefit of using UDP: A CoAP client can use UDP multicast to broadcast a message to every machine on the local network.</p>
<p>In some home automation cases, all devices will be under the same subnet, your thermostat, refrigerator, television, light switches, and other home appliances have cheap embedded processors that communicate over a local low-power network. This lets your appliances coordinate their behavior without direct input from you. When you turn the oven on, the climate control system can notice this event and turn down the heat in the kitchen. You can pull out your mobile phone, get a list of all the lights in your current room, and dim the lights through your phone, without having to go over to the light switch.</p>
<p>CoRE has registered one <a href="https://www.iana.org/assignments/multicast-addresses/multicast-addresses.xhtml">IPv4</a> and one <a href="https://www.iana.org/assignments/ipv6-multicast-addresses">IPv6</a> address each for the purpose of CoAP multicast. All CoAP Nodes can be addressed at <code>224.0.1.187</code> and at <code>FF0X::FD</code>. Nevertheless, multicast must be used with care as it is easy to create complex network problems involving broadcasting. You could do a discovery for all CoAP endpoints with:</p>
<pre><code class="language-txt">GET coap://[FF0X::FD]/.well-known/core
</code></pre>
<p>In a network that supports multicast well, you can discover the RD using a multicast query for <code>/.well-known/core</code> and the query parameter <code>?rt=core.rd*</code>. IANA has not yet decided on the multicast address to be reserved but we can assume that all CoRE RDs can be found at the IPv4 <code>224.0.1.187</code> and an additional IPv6 multicast group address <code>FF0X::FE</code> will be created in order to limit the burden on other CoAP Endpoints. The request would then be:</p>
<pre><code class="language-txt">GET coap://[FF0X::FE]/.well-known/core?rt=core.rd*
</code></pre>
<p>Notice that in the first example every CoAP endpoint will reply and in the second only those supporting RD.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="coaplinks.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="udpddos.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="coaplinks.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="udpddos.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
