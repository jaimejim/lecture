<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DDOS using CoAP - Lectures</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="ietf.html"><strong aria-hidden="true">2.</strong> The IETF</a></li><li><a href="coap.html"><strong aria-hidden="true">3.</strong> CoAP</a></li><li><ol class="section"><li><a href="coapmessage.html"><strong aria-hidden="true">3.1.</strong> A CoAP Message</a></li><li><a href="coaplinks.html"><strong aria-hidden="true">3.2.</strong> CoAP Web Linking and Serialization</a></li><li><a href="coapdiscovery.html"><strong aria-hidden="true">3.3.</strong> Finding your CoAP devices</a></li></ol></li><li><a href="udpddos.html"><strong aria-hidden="true">4.</strong> On DDOS Attacks</a></li><li><ol class="section"><li><a href="coapddos.html" class="active"><strong aria-hidden="true">4.1.</strong> DDOS using CoAP</a></li></ol></li><li><a href="reading.html"><strong aria-hidden="true">5.</strong> Relevant Articles</a></li><li><ol class="section"><li><a href="10years.html"><strong aria-hidden="true">5.1.</strong> A decade of Internet Evolution</a></li><li><a href="another10years.html"><strong aria-hidden="true">5.2.</strong> Another 10 years</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Lectures</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#ddos-using-coap" id="ddos-using-coap">DDOS using CoAP</a></h1>
<p>That CoAP can be used in malicious DDOS attacks is news but at the same time it is not. Already when the CoAP RFC was published it came with a <a href="https://tools.ietf.org/html/rfc7252#section-11">Security Section</a> with that caveat in mind, being UDP a choice made to process message faster and scale better. Today, CoAP is now deployed widely enough to be more than noticeable by malicious attackers as shown in <a href="http://i.blackhat.com/eu-18/Thu-Dec-6/eu-18-Maggi-When-Machines-Cant-Talk-wp.pdf">1</a> , <a href="http://rvasec.com/slides/2018/Rand_Dennis-RVAsec_2018.pdf">2</a> , <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-9750">3</a> and  <a href="https://www.zdnet.com/article/the-coap-protocol-is-the-next-big-thing-for-ddos-attacks">4</a>.</p>
<p>As CoAP becomes more mainstream, it is likely that there will be more attacks taking advantage of misconfigured endpoints. In fact CoAP has already been <em>&quot;occasionally used as a basis of DDOS attacks, with increasing frequency, reaching <a href="https://www.zdnet.com/article/the-coap-protocol-is-the-next-big-thing-for-ddos-attacks/">55Gbps on average</a>, and with the largest one clocking at 320Gbps&quot;</em>. Apparently the attacks are short-lived, lasting on average <em>&quot;just over <a href="https://www.securityweek.com/attackers-use-coap-ddos-amplification">90 seconds</a>&quot;</em> and feature around 100 packets per second.</p>
<p>An attack of 320Gbps is already huge, since as we saw <a href="./udpddos.html">On DDOS Attacks</a> Mirai clocked at 600Gbps. It is thus not unlikely that a 1Tbps attack using CoAP may occur relatively soon. The current peak volume clocked in an attack is of some 1.7Tbps of malicious traffic.</p>
<p>As a danish researcher at <a href="https://www.youtube.com/watch?v=DX68vb2XjdQ&amp;feature=youtu.be&amp;t=19m28s">RVAsec</a> points out, <em>the CoAP protocol was not yet mainstream back in 2017, but the number of visible CoAP endpoints has increased rapidly from about <code>6500</code> to <code>220000</code> between november 2017 and may 2018, to more than <code>738041</code> in October 2018</em>.</p>
<p>That number has decreased as devices are being patched and today we would find about <code>436854</code> running <code>:~$ shodan count port:5683</code>, out of which <code>305051</code> are in China. There are of course orders of magnitude more endpoints that are not openly visible on the Internet.</p>
<p>These attacks are based on the two vulnerabilities of UDP-based protocols mentioned in the <a href="./udpddos.html">previous section</a>.</p>
<h2><a class="header" href="#ip-address-spoofing" id="ip-address-spoofing">IP Address Spoofing</a></h2>
<p>Due to the lack of handshake in UDP, <a href="https://tools.ietf.org/html/rfc7252#section-11.4">RFC 7252, Section 11.4</a>, warns that there are some message <code>types</code> that can be spoofed on <strong>unsecured</strong> CoAP networks. They can range from simple, like a <code>RST</code> or an <code>ACK</code>in response to a <code>CON</code> message which would cause an error in the communication, to disruptive when spoofing a <strong>multicast request</strong> (cause CoAP does support multicast) for a target node. This may result in a DOS to a victim or in the congestion/collapse of the network.</p>
<p>Moreover under this attack, a constrained node with limited total energy available may exhaust that energy much more quickly than planned (battery depletion attack).</p>
<h2><a class="header" href="#amplification" id="amplification">Amplification</a></h2>
<p>As it is explained on <a href="https://tools.ietf.org/html/rfc7252#section-11.3">RFC, 7252 Section 11.3</a>, CoAP responses might be - and usually are - larger than their request. Think for example <code>GET /.well-known/core</code> that returns links to all resources, or a query to a complex sensor that returns a large JSON payload. I can imagine that if the Observe option is <code>0</code> then notifications to the victim would be sent automatically, increasing the length of the attack. Also if the crafted request asks for text-based <code>ct</code> the response would be larger than binary ones.</p>
<p>The RFC then states: <em>&quot;This is particularly a problem in nodes that enable <code>NoSec</code> access, are accessible from an attacker, and can access potential victims (e.g., on the general Internet), as the UDP protocol provides no way to verify the source address given in the request packet&quot;.</em></p>
<h3><a class="header" href="#coap-amplification-factor" id="coap-amplification-factor">CoAP Amplification Factor</a></h3>
<p>The table below is inspired from <a href="http://rvasec.com/slides/2018/Rand_Dennis-RVAsec_2018.pdf">Dennis Radd</a> presentation contains some common UDP protocols used on DDOS, the <strong>total number</strong> of endpoints available on Shodan (available at April 2019) out of which an unknown (to me) percentage will be open for an attack. The request size and amplification factor is taken from the presentation and from <a href="https://www.us-cert.gov/ncas/alerts/TA14-017A">CISA</a>.</p>
<p>The amplification factor means represents the effort for an attacker, for example in CoAP a request of <code>21</code> bytes without the UDP header of size can yield a response of <code>21*16= 336</code> bytes. The target for the attacker is to use the minimum effort for the maximum attack factor. An attacker who has access to a 1 Mbps link could on average reach 16 Mbps and up to 97 Mbps <em>per endpoint</em>.</p>
<table><thead><tr><th align="left">Protocol (port)</th><th align="right">Request size</th><th align="right">Avg/Max amplification</th><th align="right">Numbers</th></tr></thead><tbody>
<tr><td align="left">DNS (53)</td><td align="right">37 b</td><td align="right">28/54</td><td align="right">13.986.243</td></tr>
<tr><td align="left">NetBIOS (137)</td><td align="right">50 b</td><td align="right">3/229</td><td align="right">601.869</td></tr>
<tr><td align="left">SIP (5060)</td><td align="right">128 b</td><td align="right">3/19</td><td align="right">15.161.110</td></tr>
<tr><td align="left">SNPM (161)</td><td align="right">40 b</td><td align="right">34/553</td><td align="right">2.184.406</td></tr>
<tr><td align="left">NTP (123)</td><td align="right">12 b</td><td align="right">22/198</td><td align="right">9.483.324</td></tr>
<tr><td align="left"><strong>CoAP (5683)</strong></td><td align="right"><strong>21 b</strong></td><td align="right"><strong>16/97</strong></td><td align="right"><strong>436.854</strong></td></tr>
<tr><td align="left">LDAP (389)</td><td align="right">52 b</td><td align="right">45/55</td><td align="right">494.276</td></tr>
<tr><td align="left">Memcached (11211)</td><td align="right">15 b</td><td align="right">73/51000 (<a href="http://www.senki.org/memcached-on-port-11211-udp-tcp-being-exploited/">!!</a>)</td><td align="right">39.785</td></tr>
</tbody></table>
<h2><a class="header" href="#exploring-vulnerable-endpoints" id="exploring-vulnerable-endpoints">Exploring Vulnerable Endpoints</a></h2>
<p><a href="https://www.shodan.io/">Shodan</a> and <a href="https://nmap.org/">nmap</a> are the preferred tools to find out about existing vulnerable CoAP endpoints, however the usability of the first one is limited without a paid account.</p>
<script id="asciicast-192946" src="https://asciinema.org/a/192946.js" async></script>
<p>Some of Shodan's most basic commands are:</p>
<table><thead><tr><th align="left">Shodan Command</th><th align="left">Effect</th></tr></thead><tbody>
<tr><td align="left"><code>shodan host [IP_ADDRESS_HERE]</code></td><td align="left">get info on a specific endpoint</td></tr>
<tr><td align="left"><code>shodan count port:5683 country:CN</code></td><td align="left">get all CoAP endpoints in China</td></tr>
<tr><td align="left"><code>shodan stats --limit 20 port:5683</code></td><td align="left">get some statistics CoAP endpoits out there</td></tr>
<tr><td align="left"><code>shodan search --fields ip_str,port,org,hostnames port:5683 country:CN</code></td><td align="left">get a list of CoAP endpoints, their specific IPs and hostname</td></tr>
</tbody></table>
<p>There is also a web interface that allows for searching, for example <a href="https://www.shodan.io/search?query=port%3A5683">CoAP endpoints</a>. Looking a bit more on a couple of aleatory searched hosts shows two CoAP endpoints that potentially are discoverable over the Internet and vulnerable to UDP-based attacks. We can search them by issuing <code>:~$ shodan host 120.212.XXX.XXX</code></p>
<p>As we saw in the section <a href="./coapdiscovery.html">Finding your CoAP devices</a> CoAP has an in-built discovery mechanism, thus sending a <code>GET</code> request message to the <code>/.well-known/core</code> resource might show information. Indeed, for example:</p>
<ul>
<li>
<p>The node in <a href="https://pastebin.com/raw/zhZv67P5">Novgorod</a> shows the available resources, examples of the expected payloads and the interaction methods.</p>
</li>
<li>
<p>Similarly the node in <a href="https://pastebin.com/raw/CYMCFcG5">Nanchang</a> exposes network information, interfaces and all resources available, some even related to control information and the expected content-formats or passwords.</p>
</li>
</ul>
<p>If we were interested which type of devices are these , it is easy to perform an <a href="https://pastebin.com/raw/rb6Q75K9">nmap scan</a> to find out that several other TCP ports are also open, indicating that at least a portion of the devices are gateways with a dozen other services.</p>
<h2><a class="header" href="#solutions" id="solutions">Solutions</a></h2>
<p>As we other DDOS attacks, some solutions are already at hand, some outlined in <a href="https://tools.ietf.org/html/rfc4732">RFC 4732</a>, others on <a href="https://tools.ietf.org/html/rfc7252#section-11">RFC 7252</a> and on <a href="https://tools.ietf.org/html/draft-irtf-t2trg-iot-seccons-16">draft-irtf-t2trg-iot-seccons</a>. The guidelines to be followed when implementing and deploying CoAP networks that help prevent and palliate DOS attacks would be:</p>
<ul>
<li>Avoiding the use of <code>NoSec</code> mode, using instead any of the other <a href="https://tools.ietf.org/html/rfc7252#section-9">secure modes</a>.</li>
<li>Avoid exposing CoAP endpoints to the wider Internet if they don't need to.</li>
<li>Using a randomized <code>token</code> value.</li>
<li>When using <code>CON</code> messages we can detect unexpected <code>ACK</code> <code>RST</code> from the deceived endpoint. However it is costly and not always feasible.</li>
<li>Verify every now and then that observations are still valid by sending a <code>CON</code> from the observed CoAP resource.</li>
<li>Limiting the response rate can also palliate the problem.</li>
<li>Routers and middleboxes have high bandwidth, which is a scarce resource in the case of constrained networks. That will be a mitigating factor, making CoAP nodes less attractive for this attack.</li>
<li>Large amplification factors should not be provided if the request is not authenticated.</li>
<li>CoAP servers should not accept multicast requests that can not be authenticated in some way</li>
<li>Ensure all default passwords are changed to strong passwords.</li>
<li>Update IoT devices with security patches as soon as patches become available.</li>
<li>Network operators could prevent the leakage of packets with forged source addresses by following the guidelines of <a href="https://tools.ietf.org/html/rfc2827">RFC 2827</a>.</li>
</ul>
<p>Nevertheless, as it is pointed out in <a href="./another10years.html">Another 10 years</a>:</p>
<blockquote>
<p>The Internet of Things will continue to be a market place where the compromises between price and quality will continue to push us on to the side of cheap rather than secure.</p>
</blockquote>
<p>Bonus: <strong><a href="https://youtu.be/wbMrVzUpXss">Richard Thieme - Staring into the Abyss</a></strong></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="udpddos.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="reading.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="udpddos.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="reading.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
